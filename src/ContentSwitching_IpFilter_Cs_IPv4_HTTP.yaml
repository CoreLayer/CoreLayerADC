name: ContentSwitching_IpFilter_Cs_IPv4
dependencies:
  - Core
  - ContentSwitching_IpFilter_Cs
placeholders:
  - name: PLH_CSP_IPFILTER_CS_IPV4
    expression: CSP__V__IPFILTER_CS_IPV4

  - name: PLH_RSP_VAR_IPFILTER_CS_IPV4_ASSIGN
    expression: RSP__V__VAR_IPFILTER_CS_IPV4_ASSIGN

  # IPV4 - HTTP
  - name: PLH_CSP_IPFILTER_CS_IPV4_032_HTTP
    expression: CSP__V__IPFILTER_CS_IPV4_032_HTTP
  - name: PLH_LOG_CSP_IPFILTER_CS_IPV4_032_HTTP
    expression: LOG__V__CSP_IPFILTER_CS_IPV4_032_HTTP
  - name: PLH_RSP_IPFILTER_CS_IPV4_032_HTTP
    expression: RSP_IPFILTER_CS_IPV4_032_HTTP
  - name: PLH_LOG_RSP_IPFILTER_CS_IPV4_032_HTTP
    expression: LOG_RSP_IPFILTER_CS_IPV4_032_HTTP

#LBV_IPFILTER_CS_HTTP

sections:
  - name: Auditing.MessageActions
    elements:
      - name: LOG_CSP_IPFILTER_CS_IPV4_032_HTTP
        references:
          - PLH_CSP_IPFILTER_CS_IPV4_032_HTTP
          - PLH_LOG_CSP_IPFILTER_CS_IPV4_032_HTTP
        expressions:
          install: add audit messageAction PLH_LOG_CSP_IPFILTER_CS_IPV4_032_HTTP INFO q{PLH_PSM_CS_TCP_KEY + "policy=PLH_CSP_IPFILTER_CS_IPV4_032_HTTP"}
          uninstall: rm audit messageAction PLH_LOG_CSP_IPFILTER_CS_IPV4_032_HTTP
      - name: LOG_RSP_IPFILTER_CS_IPV4_032_HTTP
        references:
          - PLH_RSP_IPFILTER_CS_IPV4_032_HTTP
          - PLH_LOG_RSP_IPFILTER_CS_IPV4_032_HTTP
        expressions:
          install: add audit messageAction PLH_LOG_RSP_IPFILTER_CS_IPV4_032_HTTP INFO q{PLH_PSM_CS_TCP_KEY + "policy=PLH_RSP_IPFILTER_CS_IPV4_032_HTTP"}
          uninstall: rm audit messageAction PLH_LOG_RSP_IPFILTER_CS_IPV4_032_HTTP

  - name: AppExpert.Variables
    elements:
      - name: VAR_IPFILTER_CACHE_ASSIGN_IPV4
        references:
          - PLH_VAR_IPFILTER_CACHE
        dependencies:
          - VAR_IPFILTER_CACHE
        expressions:
          install: add ns assignment PLH_VAR_IPFILTER_CACHE_ASSIGN_IPV4 -variable q{$PLH_VAR_IPFILTER_CACHE[PLH_PSM_CS_TCP_KEY + ";ipfilter=" + PLH_PSM_CS_TCP_VALUE_IPFILTER + ";ip=" + PLH_IPV4_SRC_032]} -set q{PLH_IPV4_SRC_032}
          uninstall: rm ns assignment PLH_VAR_IPFILTER_CACHE_ASSIGN_IPV4


  - name: AppExpert.ResponderPolicies
    elements:
      - name: RSP_VAR_IPFILTER_CS_IPV4_ASSIGN
        references:
          - PLH_RSP_VAR_IPFILTER_CS_IPV4_ASSIGN
          - PLH_LBV_IPFILTER_CS_HTTP
        dependencies:
          - VAR_IPFILTER_CACHE_ASSIGN_IPV4
          - LBV_IPFILTER_CS_HTTP
        expressions:
          install: |
            add responder policy PLH_RSP_VAR_IPFILTER_CS_IPV4_ASSIGN  q{!CLIENT.IP.SRC.IS_IPV6} PLH_VAR_IPFILTER_CACHE_ASSIGN_IPV4
            bind lb vserver PLH_LBV_IPFILTER_CS_HTTP -policyName PLH_RSP_VAR_IPFILTER_CS_IPV4_ASSIGN -priority 101 -gotoPriorityExpression NEXT
          uninstall: |
            unbind lb vserver PLH_LBV_IPFILTER_CS_HTTP -policyName PLH_RSP_VAR_IPFILTER_CS_IPV4_ASSIGN
            rm responder policy PLH_RSP_VAR_IPFILTER_CS_IPV4_ASSIGN

  - name: TrafficManagement.ContentSwitching.ContentSwitchingPolicies
    elements:
      - name: CSP_IPFILTER_CS_IPV4
        references:
          - PLH_CSP_IPFILTER_CS_IPV4
        expressions:
          install: |
            add cs policy PLH_CSP_IPFILTER_CS_IPV4 -rule q{!CLIENT.IP.SRC.IS_IPV6}
            bind cs policylabel PLH_CSL_IPFILTER_CS_HTTP PLH_CSP_IPFILTER_CS_IPV4 2011 -gotoPriorityExpression 2101
          uninstall: |
            unbind cs policylabel PLH_CSL_IPFILTER_CS_HTTP PLH_CSP_IPFILTER_CS_IPV4
            rm cs policy PLH_CSP_IPFILTER_CS_IPV4

      - name: CSP_IPFILTER_CS_IPV4_032_HTTP
        references:
          - PLH_CSP_IPFILTER_CS_IPV4_032_HTTP
          - PLH_PSM_IPFILTER_CS_IPV4_032_TCP_KEY_EXISTS
          - PLH_CSA_IPFILTER_CS_HTTP
          - PLH_LOG_CSP_IPFILTER_CS_IPV4_032_HTTP
          - PLH_CSL_IPFILTER_CS_HTTP
        dependencies:
          - LOG_CSP_IPFILTER_CS_IPV4_032_HTTP
          - CSL_IPFILTER_CS_HTTP
          - CSA_IPFILTER_CS_HTTP
        expressions:
          install: |
            add cs policy PLH_CSP_IPFILTER_CS_IPV4_032_HTTP -rule q{PLH_PSM_IPFILTER_CS_IPV4_032_TCP_KEY_EXISTS} -action PLH_CSA_IPFILTER_CS_HTTP -logAction PLH_LOG_CSP_IPFILTER_CS_IPV4_032_HTTP
            bind cs policylabel PLH_CSL_IPFILTER_CS_HTTP PLH_CSP_IPFILTER_CS_IPV4_032_HTTP 2101
          uninstall: |
            unbind cs policylabel PLH_CSL_IPFILTER_CS_HTTP PLH_CSP_IPFILTER_CS_IPV4_032_HTTP
            rm cs policy PLH_CSP_IPFILTER_CS_IPV4_032_HTTP